{% extends 'dashboard/base.html' %}

{% block extra_css %}
<style>
    #map {
        height: 65vh; /* Adjusted height */
        width: 100%;
    }
    #debug-status {
        max-height: 200px; /* Max height for debug panel */
        overflow-y: auto;
        font-size: 0.75rem;
        word-break: break-all;
    }
    .accordion-button {
        font-size: 1rem;
    }
    .statistics-card {
        border: 1px solid #dee2e6;
        border-radius: .25rem;
        padding: 1rem;
        height: 100%;
    }
    .district-info {
        background-color: #f8f9fa;
        border-radius: .25rem;
        padding: 0.5rem;
        margin-top: 0.5rem;
        border-left: 3px solid #007bff;
        max-height: 300px;
        overflow-y: auto;
    }
    .district-list {
        margin: 0.25rem 0;
        line-height: 1.3;
    }
    .district-item {
        border: 1px solid #e9ecef;
        border-radius: 5px;
        padding: 8px;
        margin-bottom: 6px;
        background-color: #ffffff;
    }
    .district-item:hover {
        background-color: #f8f9fa;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .district-item:last-child {
        border-bottom: none;
    }
    .risk-indicator {
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.7rem;
        font-weight: bold;
        text-transform: uppercase;
        min-width: 40px;
        text-align: center;
        display: inline-block;
    }
    .risk-very-low { background-color: #d4edda; color: #155724; }
    .risk-low { background-color: #d1ecf1; color: #0c5460; }
    .risk-moderate { background-color: #fff3cd; color: #856404; }
    .risk-high { background-color: #f8d7da; color: #721c24; }
    .risk-very-high { background-color: #f5c6cb; color: #721c24; }
    
    /* Ward-specific styles */
    .ward-info {
        background-color: #f8f9fa;
        border-left: 3px solid #dee2e6;
        padding: 5px 8px;
        margin-top: 5px;
        border-radius: 3px;
    }
    .ward-list {
        max-height: 120px;
        overflow-y: auto;
        margin-top: 3px;
    }
    .ward-item {
        padding: 2px 0;
        border-bottom: 1px solid #e9ecef;
    }
    .ward-item:last-child {
        border-bottom: none;
    }
    
    /* Collapsible section styles */
    .btn-xs {
        padding: 0.1rem 0.3rem;
        font-size: 0.7rem;
        line-height: 1.2;
        border-radius: 0.2rem;
    }
    
    .district-item {
        border: 1px solid #e9ecef;
        border-radius: 5px;
        padding: 8px;
        margin-bottom: 6px;
        background-color: #ffffff;
    }
    
    .district-item .btn {
        font-size: 0.7rem;
        padding: 0.15rem 0.3rem;
    }
    
    .ward-info .btn {
        font-size: 0.6rem;
        padding: 0.1rem 0.25rem;
    }
    
    /* Collapse animation */
    .collapsing {
        transition: height 0.35s ease;
    }
</style>
{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="dashboard-header">
    <div class="container">
        <div class="row">
            <div class="col-12 text-center">
                <h1><i class="fas fa-globe-africa"></i> Tanzania Government Climate Prediction System</h1>
                <p class="text-muted mb-0">üèõÔ∏è <strong>Official Real-Time Satellite Data</strong> | No Mock Data | GADM Administrative Boundaries</p>
                <p class="lead">Real-time monitoring and forecasting using satellite imagery and machine learning</p>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <!-- Control Panel -->
        <div class="col-lg-3">
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-sliders-h me-2"></i> Prediction Controls</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="predictionType" class="form-label">Prediction Type</label>
                        <select class="form-select" id="predictionType">
                            <option value="flood">Flood Risk</option>
                            <option value="drought">Drought Risk</option>
                            <option value="both">Both</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="forecastDate" class="form-label">Target Date</label>
                        <input type="date" class="form-control" id="forecastDate">
                    </div>
                    <div class="mb-3">
                        <label for="forecastPeriod" class="form-label">Forecast Period</label>
                        <select class="form-select" id="forecastPeriod">
                            <option value="0">Current</option>
                            <option value="7">7 Days</option>
                            <option value="14">14 Days</option>
                            <option value="21">21 Days</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="administrativeLevel" class="form-label">Administrative Level</label>
                        <select class="form-select" id="administrativeLevel">
                            <option value="regions">Regions</option>
                            <option value="districts">Districts</option>
                        </select>
                    </div>
                    <button class="btn btn-primary w-100" onclick="updatePredictions()">
                        <i class="fas fa-sync-alt"></i> Update Predictions
                    </button>
                </div>
            </div>
            
            <!-- Quick Access to New Features -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-rocket me-2"></i> Quick Access</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'dashboard:drought_alerts' %}" class="btn btn-warning btn-sm">
                            <i class="fas fa-exclamation-triangle me-1"></i> Drought Monitoring
                        </a>
                        <a href="{% url 'dashboard:agricultural_advisory' %}" class="btn btn-success btn-sm">
                            <i class="fas fa-seedling me-1"></i> Agricultural Advisory
                        </a>
                        <button class="btn btn-info btn-sm" onclick="loadEnhancedDroughtData()">
                            <i class="fas fa-chart-area me-1"></i> Enhanced Analysis
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i> Legend</h5>
                </div>
                <div class="card-body">
                    <div id="flood-legend" class="legend-section">
                        <h6>Flood Risk</h6>
                        <div class="legend-item"><div class="legend-color" style="background-color: #ADD8E6;"></div><span>Very Low</span></div>
                        <div class="legend-item"><div class="legend-color" style="background-color: #87CEEB;"></div><span>Low</span></div>
                        <div class="legend-item"><div class="legend-color" style="background-color: #4682B4;"></div><span>Moderate</span></div>
                        <div class="legend-item"><div class="legend-color" style="background-color: #0000FF;"></div><span>High</span></div>
                        <div class="legend-item"><div class="legend-color" style="background-color: #00008B;"></div><span>Very High</span></div>
                    </div>
                    <div id="drought-legend" class="legend-section mt-3" style="display: none;">
                        <h6>Drought Risk</h6>
                        <div class="legend-item"><div class="legend-color" style="background-color: #228B22;"></div><span>Very Low</span></div>
                        <div class="legend-item"><div class="legend-color" style="background-color: #90EE90;"></div><span>Low</span></div>
                        <div class="legend-item"><div class="legend-color" style="background-color: #FFFF66;"></div><span>Moderate</span></div>
                        <div class="legend-item"><div class="legend-color" style="background-color: #FF6600;"></div><span>High</span></div>
                        <div class="legend-item"><div class="legend-color" style="background-color: #8B0000;"></div><span>Very High</span></div>
                    </div>
                </div>
            </div>
            <div class="accordion" id="debugAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingDebug">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDebug" aria-expanded="false" aria-controls="collapseDebug">
                            <i class="fas fa-bug me-2"></i> Debug Status
                        </button>
                    </h2>
                    <div id="collapseDebug" class="accordion-collapse collapse" aria-labelledby="headingDebug" data-bs-parent="#debugAccordion">
                        <div class="card-body">
                            <div id="debug-status" class="small text-muted"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Map and Statistics Container -->
        <div class="col-lg-9">
            <!-- Map Card -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-map"></i> Interactive Prediction Map</h5>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-secondary" onclick="resetMapView()"><i class="fas fa-sync-alt"></i> Reset View</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleFullscreen()"><i class="fas fa-expand"></i> Fullscreen</button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="map">
                        <div class="map-controls">
                            <div class="form-check"><input class="form-check-input" type="checkbox" id="administrativeBoundaries" checked><label class="form-check-label" for="administrativeBoundaries">Administrative Boundaries</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" id="floodLayer"><label class="form-check-label" for="floodLayer">Flood Risk</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" id="droughtLayer"><label class="form-check-label" for="droughtLayer">Drought Risk</label></div>
                            <div class="form-check form-switch mt-2"><input class="form-check-input" type="checkbox" id="satelliteBase"><label class="form-check-label" for="satelliteBase">Satellite View</label></div>
                            <div class="mt-2"><label for="layerOpacity" class="form-label small">Layer Opacity</label><input type="range" class="form-range" id="layerOpacity" min="0" max="100" value="70"></div>
                        </div>
                        <div class="region-info-panel" id="regionInfo"><h6 id="regionName">Region Details</h6><div id="regionDetails"></div></div>
                    </div>
                </div>
            </div>

            <!-- Statistics Card -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar"></i> Statistics</h5>
                </div>
                <div class="card-body">
                    <!-- Summary Statistics -->
                    <div class="row mb-4">
                        <div class="col-lg-3 col-md-6 mb-3"><div class="statistics-card text-center"><div class="h3 text-primary" id="totalRegionsAtRisk">--</div><div class="text-muted">Regions at High Risk</div></div></div>
                        <div class="col-lg-3 col-md-6 mb-3"><div class="statistics-card text-center"><div class="h3 text-warning" id="affectedArea">--</div><div class="text-muted">Affected Area (km¬≤)</div></div></div>
                        <div class="col-lg-3 col-md-6 mb-3"><div class="statistics-card text-center"><div class="h3 text-danger" id="populationAtRisk">--</div><div class="text-muted">Population at Risk</div></div></div>
                        <div class="col-lg-3 col-md-6 mb-3"><div class="statistics-card text-center"><div class="h3 text-success" id="confidenceLevel">--</div><div class="text-muted">Average Confidence</div></div></div>
                    </div>
                    <!-- Regional Statistics -->
                    <h6>Regional Details</h6>
                    <div id="regional-stats">
                        <div class="text-center"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading statistics...</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 class="mt-3">Generating Predictions...</h5>
                <p class="text-muted">Processing satellite imagery and running machine learning models</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Test function to verify JavaScript is working
console.log('JavaScript loading started');

// Global test function
function testFunction() {
    alert('JavaScript is working!');
    console.log('Test function called');
}

// Global variables
let map, floodLayer, droughtLayer, regionLayer, districtLayer;
let currentPredictions = {};

// Update predictions - MOVED TO TOP FOR ACCESSIBILITY
function updatePredictions() {
    console.log('updatePredictions function called'); // Debug log
    
    // Check if required elements exist
    const predictionTypeEl = document.getElementById('predictionType');
    const forecastDateEl = document.getElementById('forecastDate');
    const forecastPeriodEl = document.getElementById('forecastPeriod');
    const loadingModalEl = document.getElementById('loadingModal');
    
    if (!predictionTypeEl || !forecastDateEl || !forecastPeriodEl || !loadingModalEl) {
        console.error('Required elements not found for updatePredictions');
        alert('Required form elements not found. Please refresh the page.');
        return;
    }
    
    updateDebugStatus('Starting prediction update...');
    
    const loadingModal = new bootstrap.Modal(loadingModalEl);
    loadingModal.show();
    
    const predictionType = predictionTypeEl.value;
    const targetDate = forecastDateEl.value;
    const forecastDays = forecastPeriodEl.value;
    
    updateDebugStatus(`Prediction parameters: ${predictionType}, ${targetDate}, ${forecastDays} days`);
    
    // Update legend visibility
    if (typeof updateLegendVisibility === 'function') {
        updateLegendVisibility(predictionType);
    }
    
    // Fetch raster predictions
    const params = new URLSearchParams({
        date: targetDate,
        forecast_days: forecastDays
    });
    
    fetch(`/dashboard/api/raster-predictions/?${params}`)
        .then(response => {
            updateDebugStatus(`API response status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            updateDebugStatus('API response received');
            console.log('Raster predictions API response:', data);
            
            if (data.status === 'success') {
                currentPredictions = data.data;
                updateDebugStatus(`Predictions loaded: ${Object.keys(currentPredictions).join(', ')}`);
                console.log('Current predictions object:', currentPredictions);
                
                if (typeof updateMapLayers === 'function') {
                    updateMapLayers(predictionType);
                } else {
                    console.error('updateMapLayers function not found');
                    updateDebugStatus('ERROR: updateMapLayers function not found');
                }
                
                if (typeof loadRegionalStatistics === 'function') {
                    loadRegionalStatistics();
                } else {
                    console.log('loadRegionalStatistics function not found (this is optional)');
                }
            } else {
                updateDebugStatus(`API Error: ${data.message || 'Unknown error'}`);
                console.error('API Error:', data);
                showErrorMessage('Failed to load predictions: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            updateDebugStatus(`Network error: ${error.message}`);
            showErrorMessage('Network error while loading predictions');
        })
        .finally(() => {
            // Fix for aria-hidden error
            if (document.activeElement) {
                document.activeElement.blur();
            }
            loadingModal.hide();
            updateDebugStatus('Prediction update completed');
        });
}

// Ensure function is globally accessible
window.updatePredictions = updatePredictions;
console.log('updatePredictions function defined and attached to window:', typeof window.updatePredictions);

// Debug helper function
function updateDebugStatus(message) {
    const debugStatus = document.getElementById('debug-status');
    if (debugStatus) {
        const timestamp = new Date().toLocaleTimeString();
        debugStatus.innerHTML += `<div class="small text-info">[${timestamp}] ${message}</div>`;
        debugStatus.scrollTop = debugStatus.scrollHeight;
    }
    console.log('[DEBUG]', message);
}

// Initialize map
function initializeMap() {
    updateDebugStatus('üáπüáø Tanzania Government Climate System - Initializing with REAL data only...');
    updateDebugStatus('OpenLayers available: ' + (typeof ol !== 'undefined'));
    updateDebugStatus('üèõÔ∏è Government Mode: No mock data will be used');
    
    if (typeof ol === 'undefined') {
        updateDebugStatus('ERROR: OpenLayers not loaded!');
        showErrorMessage('OpenLayers library failed to load. Please refresh the page.');
        return;
    }
    
    // Check if map container exists
    const mapContainer = document.getElementById('map');
    if (!mapContainer) {
        updateDebugStatus('ERROR: Map container not found!');
        showErrorMessage('Map container element not found.');
        return;
    }
    
    updateDebugStatus('Map container found: ' + mapContainer.id);
    updateDebugStatus('Map container dimensions: ' + mapContainer.offsetWidth + 'x' + mapContainer.offsetHeight);
    updateDebugStatus('Map container visible: ' + (mapContainer.offsetParent !== null));
    
    // Base layers
    const osmLayer = new ol.layer.Tile({
        source: new ol.source.OSM(),
        title: 'OpenStreetMap'
    });
    
    const satelliteLayer = new ol.layer.Tile({
        source: new ol.source.XYZ({
            url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
            attributions: 'Esri, DigitalGlobe, GeoEye, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, and the GIS User Community'
        }),
        title: 'Satellite',
        visible: false
    });
    
    // Tanzania boundary (approximate coordinates)
    const tanzaniaExtent = ol.proj.transformExtent([29.34, -11.74, 40.32, -0.95], 'EPSG:4326', 'EPSG:3857');
    
    try {
        map = new ol.Map({
            target: 'map',
            layers: [osmLayer, satelliteLayer],
            view: new ol.View({
                center: ol.proj.fromLonLat([35.0, -6.0]), // Approximate center of Tanzania
                zoom: 6
            })
        });

        // Fit view to Tanzania extent after map is created
        const tanzaniaExtent = ol.proj.transformExtent([29.34, -11.74, 40.32, -0.95], 'EPSG:4326', 'EPSG:3857');
        map.getView().fit(tanzaniaExtent, { size: map.getSize(), padding: [10, 10, 10, 10] });
        
        // Add controls separately to avoid API issues
        map.addControl(new ol.control.ScaleLine());
        map.addControl(new ol.control.FullScreen());
        
        updateDebugStatus('Map created successfully');
        
        // Add event listeners for debugging
        map.on('loadstart', function() {
            updateDebugStatus('Map tiles loading started');
        });
        
        map.on('loadend', function() {
            updateDebugStatus('Map tiles loading completed');
        });
        
        // Ensure map renders properly
        setTimeout(() => {
            map.updateSize();
            updateDebugStatus('Map size updated after timeout');
        }, 100);
        
        // Force a render after a longer delay
        setTimeout(() => {
            map.render();
            updateDebugStatus('Map render forced');
        }, 500);
        
    } catch (error) {
        updateDebugStatus('ERROR creating map: ' + error.message);
        showErrorMessage('Failed to create map: ' + error.message);
        return;
    }
    
    updateDebugStatus('Map created successfully');
    updateDebugStatus('Map target element: ' + (document.getElementById('map') ? 'Found' : 'NOT FOUND'));
    
    // Add click handler for feature information
    map.on('click', handleMapClick);
    
    // Set today's date as default
    document.getElementById('forecastDate').value = new Date().toISOString().split('T')[0];
    
    // Validate real data only for Tanzania Government
    if (!validateRealDataOnly()) {
        return; // Stop initialization if validation fails
    }
    
    // Load initial REAL data only
    loadAdministrativeLayers();
    updatePredictions();
    
    updateDebugStatus('üáπüáø Tanzania Government map initialization completed with REAL data only');
}

// Load administrative layers from real GADM data (NO MOCK DATA FOR GOVERNMENT)
function loadAdministrativeLayers() {
    updateDebugStatus('Loading REAL GADM administrative boundaries for Tanzania Government...');
    
    fetch('/dashboard/api/administrative/')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success' && data.layers && data.layers.length > 0) {
                updateDebugStatus(`‚úÖ REAL GADM data loaded: ${data.layers.length} layers from ${data.source}`);
                console.log('REAL Administrative Layers loaded:', data);
                
                // Load real boundary layers
                data.layers.forEach(layer => {
                    if (layer.type === 'geojson') {
                        loadRealBoundaryLayer(layer);
                    } else if (layer.name.includes('regions') || layer.name.includes('districts')) {
                        addWMSLayer(layer);
                    }
                });
            } else {
                updateDebugStatus('‚ùå CRITICAL: No real administrative data available for Tanzania Government');
                console.error('GOVERNMENT PROJECT REQUIRES REAL DATA - Mock data not acceptable');
                // For Tanzania Government, we DO NOT use mock data - show error instead
                showErrorMessage('Real administrative boundaries required for Tanzania Government project. Mock data not acceptable.');
            }
        })
        .catch(error => {
            updateDebugStatus('‚ùå CRITICAL ERROR: Failed to load real administrative boundaries');
            console.error('Error loading real boundaries for Tanzania Government:', error);
            showErrorMessage('Failed to load real administrative boundaries required for Tanzania Government.');
        });
}

// Load real boundary layer data
function loadRealBoundaryLayer(layerInfo) {
    updateDebugStatus(`Loading real ${layerInfo.name} from GADM...`);
    
    fetch(layerInfo.data_url)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                updateDebugStatus(`‚úÖ Real ${layerInfo.name} loaded successfully from ${data.source}`);
                console.log(`Real ${layerInfo.name} data:`, data);
                
                // TODO: Convert GEE boundary data to vector layer for map display
                // For now, log that real data is available
                console.log(`REAL GADM ${layerInfo.boundary_type} boundaries available: ${data.feature_count} features`);
            } else {
                console.error(`Failed to load real ${layerInfo.name}:`, data.message);
            }
        })
        .catch(error => {
            console.error(`Error loading real ${layerInfo.name}:`, error);
        });
}

// Add WMS layer from GeoServer
function addWMSLayer(layerInfo) {
    console.log('Adding WMS Layer:', layerInfo);
    const wmsLayer = new ol.layer.Tile({
        source: new ol.source.TileWMS({
            url: layerInfo.wms_url,
            params: {
                'LAYERS': layerInfo.name,
                'VERSION': '1.1.1',
                'FORMAT': 'image/png',
                'TRANSPARENT': true
            },
            serverType: 'geoserver'
        }),
        title: layerInfo.title,
        opacity: 0.7
    });

    map.addLayer(wmsLayer);
    console.log('WMS Layer added to map:', wmsLayer);

    if (layerInfo.name.includes('regions')) {
        regionLayer = wmsLayer;
        console.log('Region layer initialized:', regionLayer);
    } else if (layerInfo.name.includes('districts')) {
        districtLayer = wmsLayer;
        districtLayer.setVisible(false); // Initially hidden
        console.log('District layer initialized:', districtLayer);
    }
}

// Real data validation for Tanzania Government (NO MOCK DATA ALLOWED)
function validateRealDataOnly() {
    updateDebugStatus('üèõÔ∏è Tanzania Government Project: Validating real data sources only...');
    console.log('üáπüáø TANZANIA GOVERNMENT PROJECT: Real data validation in progress');
    
    // Ensure no mock data is being used
    if (window.location.href.includes('mock') || document.body.innerHTML.includes('mock')) {
        showErrorMessage('CRITICAL: Mock data detected in Tanzania Government system. Real data required.');
        return false;
    }
    
    updateDebugStatus('‚úÖ Real data validation passed for Tanzania Government');
    return true;
}

// Update map layers based on prediction type - Tanzania Government System
function updateMapLayers(predictionType) {
    updateDebugStatus(`üáπüáø Updating map layers for: ${predictionType}`);
    
    // Remove existing prediction layers
    if (floodLayer) {
        map.removeLayer(floodLayer);
        floodLayer = null;
        updateDebugStatus('üóëÔ∏è Removed existing flood layer');
    }
    if (droughtLayer) {
        map.removeLayer(droughtLayer);
        droughtLayer = null;
        updateDebugStatus('üóëÔ∏è Removed existing drought layer');
    }
    
    // Add requested layers from currentPredictions
    let layersAdded = 0;
    
    if ((predictionType === 'flood' || predictionType === 'both') && currentPredictions.flood) {
        updateDebugStatus('üíß Adding flood prediction layer...');
        if (currentPredictions.flood.tile_url) {
            addRasterLayer('flood', currentPredictions.flood);
            layersAdded++;
        } else {
            updateDebugStatus('‚ùå Flood layer has no tile URL');
            showErrorMessage('Flood prediction data is unavailable. Please try again or contact support.');
        }
    }
    
    if ((predictionType === 'drought' || predictionType === 'both') && currentPredictions.drought) {
        updateDebugStatus('üåµ Adding drought prediction layer...');
        if (currentPredictions.drought.tile_url) {
            addRasterLayer('drought', currentPredictions.drought);
            layersAdded++;
        } else {
            updateDebugStatus('‚ùå Drought layer has no tile URL');
            showErrorMessage('Drought prediction data is unavailable. Please try again or contact support.');
        }
    }
    
    if (layersAdded === 0) {
        updateDebugStatus('‚ö†Ô∏è No prediction layers were added to the map');
        showErrorMessage(`No ${predictionType} prediction data available for the selected date and forecast period.`);
    } else {
        updateDebugStatus(`‚úÖ Added ${layersAdded} prediction layer(s) to Tanzania map`);
    }
    
    // Update layer checkboxes to reflect current state
    const floodCheckbox = document.getElementById('floodLayer');
    const droughtCheckbox = document.getElementById('droughtLayer');
    
    if (floodCheckbox) {
        floodCheckbox.checked = (predictionType === 'flood' || predictionType === 'both') && currentPredictions.flood && currentPredictions.flood.tile_url;
    }
    if (droughtCheckbox) {
        droughtCheckbox.checked = (predictionType === 'drought' || predictionType === 'both') && currentPredictions.drought && currentPredictions.drought.tile_url;
    }
    
    // Force map refresh to ensure layers are visible
    setTimeout(() => {
        map.render();
        updateDebugStatus('üó∫Ô∏è Map rendering forced after layer update');
    }, 100);
}

// Add raster layer from Earth Engine - Tanzania Government Real Data
function addRasterLayer(type, layerData) {
    updateDebugStatus(`üáπüáø Adding ${type} layer with Tanzania Government real data...`);
    
    if (!layerData.tile_url) {
        updateDebugStatus(`‚ùå ERROR: No tile URL available for ${type} layer`);
        console.error(`No tile URL for ${type} layer:`, layerData);
        showErrorMessage(`Failed to load ${type} prediction layer: No tile URL available`);
        return;
    }
    
    updateDebugStatus(`üõ∞Ô∏è Tile URL (first 100 chars): ${layerData.tile_url.substring(0, 100)}...`);
    console.log(`Adding ${type} layer with full URL:`, layerData.tile_url);
    
    // Enhanced XYZ source configuration for Google Earth Engine tiles
    const xyzSource = new ol.source.XYZ({
        url: layerData.tile_url,
        crossOrigin: null, // Let browser handle CORS for Google Earth Engine
        maxZoom: 18,
        minZoom: 1,
        wrapX: false, // Important for Earth Engine tiles
        transition: 0, // Disable transition for faster loading
        // Add cache buster for forecast tiles
        tileLoadFunction: function(tile, src) {
            // Add forecast metadata to prevent caching issues
            const cacheBuster = layerData.forecast_days ? `&cb=${Date.now()}` : '';
            const finalUrl = src.includes('?') ? src + cacheBuster : src + '?cb=' + Date.now();
            tile.getImage().src = finalUrl;
        }
    });
    
    const rasterLayer = new ol.layer.Tile({
        source: xyzSource,
        title: `${type.charAt(0).toUpperCase() + type.slice(1)} Risk - Tanzania Government Data`,
        opacity: 0.7,
        visible: true,
        zIndex: 100 // Ensure prediction layers appear above base layers
    });
    
    // Enhanced error handling for tile loading
    let tileLoadCount = 0;
    let tileErrorCount = 0;
    
    xyzSource.on('tileloaderror', function(event) {
        tileErrorCount++;
        console.error(`‚ùå Tile loading error for ${type} layer:`, event);
        updateDebugStatus(`‚ùå Tile error ${tileErrorCount} for ${type} layer`);
        
        // If too many tile errors, show user message
        if (tileErrorCount > 5) {
            updateDebugStatus(`‚ö†Ô∏è Multiple tile errors for ${type} - checking connection`);
            showErrorMessage(`Warning: Some ${type} prediction tiles failed to load. This may be due to network issues or authentication problems.`);
        }
    });
    
    xyzSource.on('tileloadstart', function(event) {
        updateDebugStatus(`üì° Loading ${type} tile...`);
    });
    
    xyzSource.on('tileloadend', function(event) {
        tileLoadCount++;
        console.log(`‚úÖ Tile loaded successfully for ${type} layer (${tileLoadCount} tiles loaded)`);
        if (tileLoadCount === 1) {
            updateDebugStatus(`‚úÖ First ${type} tile loaded successfully!`);
        }
        if (tileLoadCount % 10 === 0) {
            updateDebugStatus(`üìä ${tileLoadCount} ${type} tiles loaded`);
        }
    });
    
    // Force map refresh after adding layer
    map.addLayer(rasterLayer);
    
    // Ensure layer is visible and properly rendered
    setTimeout(() => {
        rasterLayer.setVisible(true);
        map.render();
        updateDebugStatus(`üó∫Ô∏è ${type} layer forced to render`);
    }, 100);
    
    updateDebugStatus(`‚úÖ ${type} layer added to map successfully`);
    console.log(`${type} layer added to map, total layers:`, map.getLayers().getLength());
    
    // Log layer details for debugging
    console.log(`${type} layer details:`, {
        opacity: rasterLayer.getOpacity(),
        visible: rasterLayer.getVisible(),
        zIndex: rasterLayer.getZIndex(),
        source: rasterLayer.getSource().getUrls ? rasterLayer.getSource().getUrls() : 'XYZ source'
    });
    
    if (type === 'flood') {
        floodLayer = rasterLayer;
    } else if (type === 'drought') {
        droughtLayer = rasterLayer;
    }
}

// Handle map click events
function handleMapClick(event) {
    const coordinate = event.coordinate;
    const lonLat = ol.proj.toLonLat(coordinate);
    
    // Get feature information (this would query GeoServer for feature details)
    showRegionInfo(lonLat[0], lonLat[1]);
}

// Show region information - Tanzania Government Real Data Only
function showRegionInfo(lon, lat) {
    const regionInfo = document.getElementById('regionInfo');
    const regionName = document.getElementById('regionName');
    const regionDetails = document.getElementById('regionDetails');
    
    updateDebugStatus(`üáπüáø Getting real region info for coordinates: ${lon.toFixed(4)}, ${lat.toFixed(4)}`);
    
    // Query real GADM boundary data for clicked location
    const params = new URLSearchParams({
        lon: lon.toString(),
        lat: lat.toString(),
        level: 'district' // Get district-level information
    });
    
    fetch(`/dashboard/api/boundaries/point-query/?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success' && data.data) {
                const region = data.data;
                
                regionName.textContent = region.name || 'Tanzania Region';
                regionDetails.innerHTML = `
                    <p><strong>üèõÔ∏è Government Administrative Data</strong></p>
                    <p><strong>Region:</strong> ${region.region || 'N/A'}</p>
                    <p><strong>District:</strong> ${region.district || 'N/A'}</p>
                    <p><strong>Ward:</strong> ${region.ward || 'N/A'}</p>
                    <p><strong>Administrative Level:</strong> ${region.level || 'N/A'}</p>
                    <p><strong>Coordinates:</strong> ${lon.toFixed(4)}, ${lat.toFixed(4)}</p>
                    <p><strong>Data Source:</strong> GADM Tanzania Boundaries</p>
                    <div class="mt-2">
                        <small class="text-muted">Real-time data from Tanzania Government sources</small>
                    </div>
                `;
                
                updateDebugStatus(`‚úÖ Real region data loaded: ${region.name}`);
            } else {
                // Fallback for areas outside administrative boundaries
                regionName.textContent = 'Tanzania Territory';
                regionDetails.innerHTML = `
                    <p><strong>üáπüáø Tanzania Government Territory</strong></p>
                    <p><strong>Coordinates:</strong> ${lon.toFixed(4)}, ${lat.toFixed(4)}</p>
                    <p><strong>Status:</strong> Outside mapped administrative boundaries</p>
                    <p><strong>Data Source:</strong> Tanzania Government System</p>
                    <div class="mt-2">
                        <small class="text-muted">Location within Tanzania territory</small>
                    </div>
                `;
                
                updateDebugStatus(`‚ÑπÔ∏è Location outside administrative boundaries`);
            }
        })
        .catch(error => {
            console.error('Error fetching region info:', error);
            
            regionName.textContent = 'Tanzania Territory';
            regionDetails.innerHTML = `
                <p><strong>üáπüáø Tanzania Government System</strong></p>
                <p><strong>Coordinates:</strong> ${lon.toFixed(4)}, ${lat.toFixed(4)}</p>
                <p><strong>Status:</strong> Data temporarily unavailable</p>
                <p><strong>Error:</strong> ${error.message}</p>
                <div class="mt-2">
                    <small class="text-muted">Please try again or contact system administrator</small>
                </div>
            `;
            
            updateDebugStatus(`‚ùå Error loading region data: ${error.message}`);
        });
    
    regionInfo.style.display = 'block';
}

// Load regional statistics
function loadRegionalStatistics() {
    const predictionType = document.getElementById('predictionType').value === 'both' ? 'flood' : document.getElementById('predictionType').value;
    const adminLevel = document.getElementById('administrativeLevel').value;
    const targetDate = document.getElementById('forecastDate').value;
    const forecastDays = document.getElementById('forecastPeriod').value;
    
    const params = new URLSearchParams({
        type: adminLevel,
        prediction: predictionType,
        date: targetDate,
        forecast_days: forecastDays
    });
    
    updateDebugStatus(`Loading regional statistics: ${predictionType}, ${adminLevel}, ${targetDate}, ${forecastDays} days`);
    
    fetch(`/dashboard/api/regional-statistics/?${params}`)
        .then(response => response.json())
        .then(data => {
            updateDebugStatus(`Regional statistics response: ${data.status}`);
            if (data.status === 'success') {
                updateRegionalStatistics(data.statistics);
                updateSummaryStatistics(data.statistics);
                updateDebugStatus(`Loaded ${data.statistics.length} regional statistics`);
            } else {
                updateDebugStatus(`Regional statistics error: ${data.message}`);
                console.error('Error loading regional statistics:', data.message);
            }
        })
        .catch(error => {
            updateDebugStatus(`Regional statistics fetch error: ${error.message}`);
            console.error('Error loading regional statistics:', error);
        });
}

// Update regional statistics panel with real-time data
function updateRegionalStatistics(statistics) {
    const container = document.getElementById('regional-stats');
    
    if (statistics.length === 0) {
        container.innerHTML = '<p class="text-muted">No real-time data available</p>';
        return;
    }
    
    let html = '<div class="row">';
    statistics.forEach(region => {
        const riskClass = `risk-${region.risk_level <= 1 ? 'very-low' : 
                                 region.risk_level <= 2 ? 'low' : 
                                 region.risk_level <= 3 ? 'moderate' : 
                                 region.risk_level <= 4 ? 'high' : 'very-high'}`;
        
        const riskText = region.risk_level <= 1 ? 'Very Low' : 
                        region.risk_level <= 2 ? 'Low' : 
                        region.risk_level <= 3 ? 'Moderate' : 
                        region.risk_level <= 4 ? 'High' : 'Very High';
        
        // Real-time indicators display
        let realtimeIndicators = '';
        if (region.realtime_indicators && Object.keys(region.realtime_indicators).length > 0) {
            realtimeIndicators = '<div class="mt-2 small text-info"><strong>üì° Real-time Data:</strong><br>';
            
            if (region.prediction_type === 'flood') {
                if (region.realtime_indicators.current_rainfall_mm !== undefined) {
                    realtimeIndicators += `üíß Rainfall: ${region.realtime_indicators.current_rainfall_mm}mm<br>`;
                }
                if (region.realtime_indicators.water_coverage_percent !== undefined) {
                    realtimeIndicators += `üåä Water: ${region.realtime_indicators.water_coverage_percent}%<br>`;
                }
            } else {
                if (region.realtime_indicators.vegetation_index !== undefined) {
                    const vegStatus = region.realtime_indicators.vegetation_status || 'unknown';
                    realtimeIndicators += `üå± Vegetation: ${region.realtime_indicators.vegetation_index} (${vegStatus})<br>`;
                }
                if (region.realtime_indicators.temperature_celsius !== undefined) {
                    realtimeIndicators += `üå°Ô∏è Temperature: ${region.realtime_indicators.temperature_celsius}¬∞C<br>`;
                }
                if (region.realtime_indicators.soil_moisture_index !== undefined) {
                    realtimeIndicators += `üíß Soil Moisture: ${region.realtime_indicators.soil_moisture_index}<br>`;
                }
            }
            realtimeIndicators += '</div>';
        }
        
        // Data quality indicator
        const dataQualityIcon = region.data_quality === 'high' ? 'üü¢' : 
                               region.data_quality === 'medium' ? 'üü°' : 'üî¥';
        const dataQualityText = region.data_quality === 'high' ? 'High Quality' : 
                               region.data_quality === 'medium' ? 'Medium Quality' : 'Limited Data';
        
        // Risk factors display
        let riskFactorsText = '';
        if (region.risk_factors && region.risk_factors.length > 0) {
            const factors = region.risk_factors.filter(f => f !== 'data_unavailable').slice(0, 3);
            if (factors.length > 0) {
                riskFactorsText = `<div class="small text-warning mt-1"><strong>‚ö†Ô∏è Risk Factors:</strong> ${factors.join(', ')}</div>`;
            }
        }
        
        // Format affected districts information with collapsible sections
        let districtsInfo = '';
        if (region.affected_districts && region.affected_districts.length > 0) {
            const regionId = region.region_name.replace(/\s+/g, '_').toLowerCase();
            districtsInfo = `
                <div class="district-info mt-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong class="small">üìç Affected Districts (${region.affected_districts.length})</strong>
                        <button class="btn btn-outline-secondary btn-sm" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#districts_${regionId}" 
                                aria-expanded="false" aria-controls="districts_${regionId}">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    <div class="collapse mt-2" id="districts_${regionId}">
                        <div class="district-list">
            `;
            
            region.affected_districts.forEach((district, index) => {
                const districtRiskClass = `risk-${district.risk_level <= 1 ? 'very-low' : 
                                                 district.risk_level <= 2 ? 'low' : 
                                                 district.risk_level <= 3 ? 'moderate' : 
                                                 district.risk_level <= 4 ? 'high' : 'very-high'}`;
                const districtRiskText = district.risk_level <= 1 ? 'V.Low' : 
                                       district.risk_level <= 2 ? 'Low' : 
                                       district.risk_level <= 3 ? 'Mod' : 
                                       district.risk_level <= 4 ? 'High' : 'V.High';
                
                // Generate wards section if available
                let wardsInfo = '';
                if (district.wards && district.wards.length > 0) {
                    const districtId = `${regionId}_${district.name.replace(/\s+/g, '_').toLowerCase()}`;
                    wardsInfo = `
                        <div class="ward-info mt-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">üèòÔ∏è Wards (${district.wards.length})</small>
                                <button class="btn btn-outline-secondary btn-xs" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#wards_${districtId}" 
                                        aria-expanded="false" aria-controls="wards_${districtId}">
                                    <i class="fas fa-chevron-down" style="font-size: 0.7em;"></i>
                                </button>
                            </div>
                            <div class="collapse mt-1" id="wards_${districtId}">
                                <div class="ward-list">
                    `;
                    
                    district.wards.slice(0, 10).forEach(ward => { // Show max 10 wards
                        const wardRiskClass = `risk-${ward.risk_level <= 1 ? 'very-low' : 
                                              ward.risk_level <= 2 ? 'low' : 
                                              ward.risk_level <= 3 ? 'moderate' : 
                                              ward.risk_level <= 4 ? 'high' : 'very-high'}`;
                        const wardRiskText = ward.risk_level <= 1 ? 'VL' : 
                                           ward.risk_level <= 2 ? 'L' : 
                                           ward.risk_level <= 3 ? 'M' : 
                                           ward.risk_level <= 4 ? 'H' : 'VH';
                        wardsInfo += `
                            <div class="ward-item d-flex justify-content-between align-items-center" style="padding: 1px 0;">
                                <span class="small text-muted" style="flex: 1; margin-right: 0.3rem;">${ward.name}</span>
                                <span class="risk-indicator ${wardRiskClass}" style="font-size: 0.7em; padding: 1px 3px;">${wardRiskText}</span>
                            </div>
                        `;
                    });
                    
                    if (district.wards.length > 10) {
                        wardsInfo += `
                            <div class="text-muted" style="font-size: 0.7em; text-align: center; padding: 2px 0;">
                                ... and ${district.wards.length - 10} more wards
                            </div>
                        `;
                    }
                    
                    wardsInfo += `
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                districtsInfo += `
                    <div class="district-item mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="small text-dark" style="flex: 1; margin-right: 0.5rem; font-weight: 500;">${district.name}</span>
                            <span class="risk-indicator ${districtRiskClass}">${districtRiskText}</span>
                        </div>
                        ${wardsInfo}
                    </div>
                `;
            });
            
            districtsInfo += `
                        </div>
                    </div>
                </div>
            `;
        }
        
        html += `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="statistics-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <h6 class="mb-2">${region.region_name}</h6>
                        <div class="text-right">
                            <span class="risk-indicator ${riskClass}">${riskText}</span>
                            <div class="small text-muted mt-1">${dataQualityIcon} ${dataQualityText}</div>
                        </div>
                    </div>
                    
                    <div class="mt-2">
                        <div class="row small">
                            <div class="col-6">
                                <strong>Population at Risk:</strong><br>
                                <span class="text-danger">${region.population_at_risk?.toLocaleString() || 'N/A'}</span>
                                <span class="text-muted">/ ${region.total_population?.toLocaleString() || 'N/A'}</span>
                            </div>
                            <div class="col-6">
                                <strong>Affected Area:</strong><br>
                                <span class="text-warning">${region.affected_area_km2?.toLocaleString() || 'N/A'} km¬≤</span>
                                <span class="text-muted">/ ${region.total_area_km2?.toLocaleString() || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-2 small">
                        <div class="d-flex justify-content-between">
                            <span><strong>Confidence:</strong></span>
                            <span class="${region.confidence >= 0.8 ? 'text-success' : region.confidence >= 0.6 ? 'text-warning' : 'text-danger'}">
                                ${Math.round((region.confidence || 0.7) * 100)}%
                            </span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span><strong>Risk Score:</strong></span>
                            <span>${region.risk_score || 'N/A'}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span><strong>Last Updated:</strong></span>
                            <span class="text-muted">${formatLastUpdated(region.last_updated)}</span>
                        </div>
                    </div>
                    
                    ${realtimeIndicators}
                    ${riskFactorsText}
                    ${districtsInfo}
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
}

// Helper function to format last updated time
function formatLastUpdated(timestamp) {
    if (!timestamp) return 'N/A';
    
    try {
        const date = new Date(timestamp);
        const now = new Date();
        const diffMinutes = Math.floor((now - date) / (1000 * 60));
        
        if (diffMinutes < 1) return 'Just now';
        if (diffMinutes < 60) return `${diffMinutes}m ago`;
        if (diffMinutes < 1440) return `${Math.floor(diffMinutes / 60)}h ago`;
        return date.toLocaleDateString();
    } catch (e) {
        return 'N/A';
    }
}

// Update summary statistics
function updateSummaryStatistics(statistics) {
    const highRiskRegions = statistics.filter(r => r.risk_level >= 4).length;
    const totalArea = statistics.reduce((sum, r) => sum + r.affected_area_km2, 0);
    const totalPopulation = statistics.reduce((sum, r) => sum + r.population_at_risk, 0);
    const avgConfidence = statistics.reduce((sum, r) => sum + r.confidence, 0) / statistics.length;
    
    document.getElementById('totalRegionsAtRisk').textContent = highRiskRegions;
    document.getElementById('affectedArea').textContent = totalArea.toLocaleString();
    document.getElementById('populationAtRisk').textContent = totalPopulation.toLocaleString();
    document.getElementById('confidenceLevel').textContent = (avgConfidence * 100).toFixed(1) + '%';
}

// Update legend visibility
function updateLegendVisibility(predictionType) {
    const floodLegend = document.getElementById('flood-legend');
    const droughtLegend = document.getElementById('drought-legend');
    
    floodLegend.style.display = (predictionType === 'flood' || predictionType === 'both') ? 'block' : 'none';
    droughtLegend.style.display = (predictionType === 'drought' || predictionType === 'both') ? 'block' : 'none';
}

// Reset map view
function resetMapView() {
    map.getView().setCenter(ol.proj.fromLonLat([35.0, -6.0]));
    map.getView().setZoom(6);
}

// Load enhanced drought data
function loadEnhancedDroughtData() {
    console.log('Loading enhanced drought data...');
    updateDebugStatus('Loading enhanced drought monitoring data...');
    
    // Show loading modal
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();
    
    // Make API call to enhanced drought monitoring endpoint
    fetch('/dashboard/api/enhanced-drought-monitoring/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            start_date: getDateDaysAgo(30),
            end_date: new Date().toISOString().split('T')[0]
        })
    })
    .then(response => response.json())
    .then(data => {
        loadingModal.hide();
        
        if (data.status === 'success') {
            console.log('Enhanced drought data loaded:', data);
            updateDebugStatus('Enhanced drought data loaded successfully');
            
            // Add drought layer to map if available
            if (data.data.composite_index_url) {
                addEnhancedDroughtLayer(data.data.composite_index_url);
            }
            
            // Show success message
            showSuccessMessage('Enhanced drought monitoring data loaded successfully! Check the map for composite drought index.');
            
            // Show alerts summary if available
            if (data.data.alerts && data.data.alerts.length > 0) {
                const criticalAlerts = data.data.alerts.filter(alert => alert.alert_level === 'CRITICAL');
                if (criticalAlerts.length > 0) {
                    showWarningMessage(`Warning: ${criticalAlerts.length} region(s) under CRITICAL drought conditions. Visit Drought Monitoring page for details.`);
                }
            }
        } else {
            console.error('Failed to load enhanced drought data:', data.message);
            updateDebugStatus('Failed to load enhanced drought data: ' + data.message);
            showErrorMessage('Failed to load enhanced drought data: ' + data.message);
        }
    })
    .catch(error => {
        loadingModal.hide();
        console.error('Error loading enhanced drought data:', error);
        updateDebugStatus('Error loading enhanced drought data: ' + error.message);
        showErrorMessage('Error loading enhanced drought data. Please check your connection and try again.');
    });
}

// Add enhanced drought layer to map
function addEnhancedDroughtLayer(tileUrl) {
    // Remove existing enhanced drought layer if present
    const layers = map.getLayers().getArray();
    const existingLayer = layers.find(layer => layer.get('title') === 'Enhanced Drought');
    if (existingLayer) {
        map.removeLayer(existingLayer);
    }
    
    // Create new enhanced drought layer
    const enhancedDroughtLayer = new ol.layer.Tile({
        title: 'Enhanced Drought',
        source: new ol.source.XYZ({
            url: tileUrl,
            crossOrigin: 'anonymous'
        }),
        opacity: 0.7
    });
    
    // Add to map
    map.addLayer(enhancedDroughtLayer);
    
    console.log('Enhanced drought layer added to map');
}

// Helper function to get date days ago
function getDateDaysAgo(days) {
    const date = new Date();
    date.setDate(date.getDate() - days);
    return date.toISOString().split('T')[0];
}

// Show success message
function showSuccessMessage(message) {
    showMessage(message, 'success');
}

// Show warning message
function showWarningMessage(message) {
    showMessage(message, 'warning');
}

// Show error message
function showErrorMessage(message) {
    showMessage(message, 'danger');
}

// Generic message function
function showMessage(message, type) {
    // Remove any existing messages of this type first
    const existingAlerts = document.querySelectorAll(`.alert-${type}`);
    existingAlerts.forEach(alert => alert.remove());
    
    // Create a temporary alert
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-2`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Find the container and add the alert at the top
    const container = document.querySelector('.container-fluid');
    if (container) {
        container.insertAdjacentElement('afterbegin', alertDiv);
    } else {
        // Fallback to body if container not found
        document.body.insertAdjacentElement('afterbegin', alertDiv);
    }
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Toggle fullscreen
function toggleFullscreen() {
    if (!document.fullscreenElement) {
        document.getElementById('map').requestFullscreen();
    } else {
        document.exitFullscreen();
    }
}

// Layer control event handlers
document.addEventListener('DOMContentLoaded', function() {
    // Wait a bit to ensure all CSS is loaded
    setTimeout(() => {
        initializeMap();
        // Auto-load predictions on page load
        setTimeout(() => {
            console.log('Auto-loading predictions on page load...');
            updatePredictions();
        }, 1000); // Wait 1 second after map initialization
    }, 250);
    
    // Administrative level change handler
    document.getElementById('administrativeLevel').addEventListener('change', function() {
        const level = this.value;
        const isVisible = document.getElementById('administrativeBoundaries').checked;
        if (regionLayer) {
            regionLayer.setVisible(level === 'regions' && isVisible);
        }
        if (districtLayer) {
            districtLayer.setVisible(level === 'districts' && isVisible);
        }
    });
    
    // Layer visibility controls
    document.getElementById('administrativeBoundaries').addEventListener('change', function() {
        const level = document.getElementById('administrativeLevel').value;
        const isVisible = this.checked;
        if (level === 'regions' && regionLayer) {
            regionLayer.setVisible(isVisible);
        } else if (level === 'districts' && districtLayer) {
            districtLayer.setVisible(isVisible);
        }
    });
    
    document.getElementById('floodLayer').addEventListener('change', function() {
        if (floodLayer) {
            floodLayer.setVisible(this.checked);
        }
    });
    
    document.getElementById('droughtLayer').addEventListener('change', function() {
        if (droughtLayer) {
            droughtLayer.setVisible(this.checked);
        }
    });
    
    document.getElementById('satelliteBase').addEventListener('change', function() {
        const layers = map.getLayers().getArray();
        const satelliteLayer = layers.find(layer => layer.get('title') === 'Satellite');
        const osmLayer = layers.find(layer => layer.get('title') === 'OpenStreetMap');
        
        if (this.checked) {
            satelliteLayer.setVisible(true);
            osmLayer.setVisible(false);
        } else {
            satelliteLayer.setVisible(false);
            osmLayer.setVisible(true);
        }
    });
    
    // Opacity control
    document.getElementById('layerOpacity').addEventListener('input', function() {
        const opacity = this.value / 100;
        if (floodLayer) floodLayer.setOpacity(opacity);
        if (droughtLayer) droughtLayer.setOpacity(opacity);
        if (regionLayer) regionLayer.setOpacity(opacity);
        if (districtLayer) districtLayer.setOpacity(opacity);
    });
    
    // Hide region info when clicking elsewhere
    document.addEventListener('click', function(event) {
        if (!event.target.closest('#regionInfo') && !event.target.closest('#map')) {
            document.getElementById('regionInfo').style.display = 'none';
        }
    });

    // Additional functions for compatibility
    
    // Simple initMap function for Leaflet compatibility
    function initMap() {
        // This function is provided for compatibility
        // The main map is initialized by initializeMap() using OpenLayers
        console.log('initMap() called - using OpenLayers implementation instead');
    }
    
    // Load predictions function (simplified)
    function loadPredictions() {
        updatePredictions();
    }
    
    // Show/hide loading function (simplified)
    function showLoading(show) {
        const loadingModal = document.getElementById('loadingModal');
        if (loadingModal) {
            if (show) {
                new bootstrap.Modal(loadingModal).show();
            } else {
                bootstrap.Modal.getInstance(loadingModal)?.hide();
            }
        }
    }
    
    // Show error function (simplified)
    function showError(message) {
        showErrorMessage(message);
    }
    
    // Hide error function (simplified)
    function hideError() {
        // Hide any error messages
        const errorElements = document.querySelectorAll('.alert-danger');
        errorElements.forEach(el => el.style.display = 'none');
    }
    
    // Update last updated time
    function updateLastUpdated() {
        const now = new Date();
        const lastUpdatedElement = document.getElementById('lastUpdated');
        if (lastUpdatedElement) {
            lastUpdatedElement.textContent = now.toLocaleString();
        }
    }
    
    // Historical data function (placeholder)
    function showHistoricalData() {
        alert('Historical data feature coming soon!');
    }
});

// DOMContentLoaded event listener for binding updatePredictions
document.addEventListener('DOMContentLoaded', () => {
    const updateButton = document.querySelector('button[onclick="updatePredictions()"]');
    if (updateButton) {
        updateButton.addEventListener('click', updatePredictions);
        console.log('Event listener added to update button');
    }
});
</script>
{% endblock %}

